<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Live Timing - F1 Assetto Corsa</title>
  <style>
    :root{
      --bg0:#07090f;
      --bg1:#0b1020;
      --card:#0e1730cc;
      --card2:#0b1328cc;
      --border:#22325a;
      --txt:#e9eeff;
      --muted:#9bb0ffb0;
      --accent:#7aa2ff;
      --good:#38d39f;
      --warn:#ffcc66;
      --bad:#ff6b6b;
      --shadow: 0 12px 40px rgba(0,0,0,.45);
      --radius: 18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: var(--sans);
      color:var(--txt);
      background:
        radial-gradient(1100px 600px at 15% 10%, #14224c 0%, transparent 55%),
        radial-gradient(900px 500px at 85% 20%, #2a164e 0%, transparent 55%),
        radial-gradient(800px 600px at 50% 90%, #0f2a3d 0%, transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    .wrap{
      max-width: 1280px;
      margin: 0 auto;
      padding: 18px 16px 32px;
    }

    /* top bar */
    .topbar{
      display:flex;
      gap:14px;
      align-items:center;
      justify-content:space-between;
      padding:14px 14px;
      border:1px solid var(--border);
      background: linear-gradient(180deg, rgba(18,28,60,.85), rgba(10,16,36,.75));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      position: sticky;
      top: 10px;
      backdrop-filter: blur(10px);
      z-index: 20;
    }
    .brand{
      display:flex;
      gap:12px;
      align-items:center;
      min-width: 260px;
    }
    .logo{
      width:38px;height:38px;border-radius:12px;
      background:
        radial-gradient(12px 12px at 30% 30%, #fff8 0%, transparent 60%),
        linear-gradient(135deg, #6dd5ff, #7f53ff);
      box-shadow: 0 8px 24px rgba(127,83,255,.35);
    }
    .title{
      display:flex;
      flex-direction:column;
      gap:2px;
      line-height:1.1;
    }
    .title b{ font-size:14px; letter-spacing:.2px; }
    .title span{ font-size:12px; color: var(--muted); }

    .controls{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-end;
    }

    .field{
      display:flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border:1px solid var(--border);
      border-radius: 14px;
      background: rgba(7,12,28,.65);
    }
    .field label{
      font-size:12px;
      color: var(--muted);
      white-space:nowrap;
    }
    .field input{
      width: 170px;
      background: transparent;
      border:0;
      outline:none;
      color:var(--txt);
      font-family: var(--mono);
      font-size:12px;
    }
    .field input.short{ width: 70px; text-align:center; }

    .btn{
      border:1px solid var(--border);
      background: linear-gradient(180deg, rgba(122,162,255,.22), rgba(122,162,255,.10));
      color: var(--txt);
      padding:10px 12px;
      border-radius: 14px;
      cursor:pointer;
      font-weight:600;
      font-size:12px;
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      gap:8px;
      box-shadow: 0 10px 25px rgba(0,0,0,.22);
      user-select:none;
    }
    .btn:hover{ filter: brightness(1.06); }
    .btn:active{ transform: translateY(1px); }
    .btn.secondary{
      background: rgba(7,12,28,.65);
      font-weight:600;
    }
    .btn.danger{
      border-color: rgba(255,107,107,.35);
      background: linear-gradient(180deg, rgba(255,107,107,.22), rgba(255,107,107,.10));
    }

    .chip{
      padding:8px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(7,12,28,.65);
      font-size:12px;
      display:flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
    }
    .dot{
      width:8px;height:8px;border-radius:99px;background: var(--muted);
      box-shadow: 0 0 0 3px rgba(155,176,255,.12);
    }
    .dot.ok{ background: var(--good); box-shadow: 0 0 0 3px rgba(56,211,159,.15); }
    .dot.bad{ background: var(--bad); box-shadow: 0 0 0 3px rgba(255,107,107,.15); }
    .dot.warn{ background: var(--warn); box-shadow: 0 0 0 3px rgba(255,204,102,.15); }

    /* grid */
    .grid{
      margin-top: 14px;
      display:grid;
      grid-template-columns: 1.35fr .95fr;
      gap: 14px;
      align-items:start;
    }
    @media (max-width: 1020px){
      .grid{ grid-template-columns: 1fr; }
      .brand{ min-width: unset; }
    }

    .card{
      border:1px solid var(--border);
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(14,23,48,.78), rgba(9,14,30,.78));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:12px 14px;
      border-bottom:1px solid rgba(34,50,90,.65);
      background: linear-gradient(180deg, rgba(255,255,255,.03), transparent);
    }
    .card .hd h2{
      margin:0;
      font-size:13px;
      letter-spacing:.3px;
    }
    .card .hd small{ color: var(--muted); font-size:12px; }
    .card .bd{ padding: 12px 14px; }

    /* table */
    table{
      width:100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    thead th{
      text-align:left;
      color: var(--muted);
      font-weight:700;
      padding:10px 10px;
      border-bottom:1px solid rgba(34,50,90,.65);
      letter-spacing:.2px;
    }
    tbody td{
      padding:10px 10px;
      border-bottom:1px solid rgba(34,50,90,.35);
      vertical-align:middle;
    }
    tbody tr:hover{
      background: rgba(122,162,255,.06);
    }
    .pos{
      width:52px;
      font-family: var(--mono);
      font-weight:800;
      color:#fff;
    }
    .name{
      font-weight:800;
      letter-spacing:.1px;
    }
    .sub{
      display:block;
      color: var(--muted);
      font-size: 11px;
      margin-top:2px;
    }
    .mono{ font-family: var(--mono); }
    .right{ text-align:right; }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:5px 8px;
      border-radius: 999px;
      border:1px solid rgba(34,50,90,.8);
      background: rgba(7,12,28,.55);
      font-size:11px;
      color: var(--muted);
    }
    .badge .tiny{
      width:6px;height:6px;border-radius:99px;background: var(--muted);
    }
    .badge.live .tiny{ background: var(--good); }

    .leader{
      background: linear-gradient(90deg, rgba(56,211,159,.12), transparent);
    }

    /* map */
    .mapWrap{
      position:relative;
      border: 1px solid rgba(34,50,90,.65);
      border-radius: 16px;
      overflow:hidden;
      background: rgba(7,12,28,.55);
      aspect-ratio: 16/10;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.03);
    }
    .mapWrap img{
      width:100%;
      height:100%;
      object-fit:contain;
      display:block;
      opacity: .96;
      filter: contrast(1.05) saturate(1.05);
      user-select:none;
      pointer-events:none;
    }
    .layer{
      position:absolute; inset:0;
      pointer-events:none;
    }
    .carDot{
      position:absolute;
      width:10px; height:10px;
      border-radius: 99px;
      transform: translate(-50%,-50%);
      background: var(--accent);
      box-shadow: 0 0 0 3px rgba(122,162,255,.22), 0 12px 24px rgba(0,0,0,.25);
      border: 1px solid rgba(255,255,255,.22);
    }
    .carDot.me{ background:#ff5a9e; box-shadow: 0 0 0 3px rgba(255,90,158,.22), 0 12px 24px rgba(0,0,0,.25); }
    .carLabel{
      position:absolute;
      transform: translate(8px,-18px);
      font-size: 10px;
      padding: 3px 6px;
      border-radius: 999px;
      border:1px solid rgba(34,50,90,.8);
      background: rgba(7,12,28,.65);
      color: var(--txt);
      white-space:nowrap;
      max-width: 200px;
      overflow:hidden;
      text-overflow: ellipsis;
    }

    .miniRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      margin-top: 10px;
    }
    .toggles{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .toggle{
      display:flex;
      gap:8px;
      align-items:center;
      padding:8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(34,50,90,.8);
      background: rgba(7,12,28,.55);
      font-size: 12px;
      color: var(--muted);
      cursor:pointer;
      user-select:none;
    }
    .toggle input{ accent-color: var(--accent); cursor:pointer; }
    .hint{
      color: var(--muted);
      font-size: 12px;
      line-height:1.45;
    }

    details{
      margin-top: 10px;
      border:1px solid rgba(34,50,90,.65);
      border-radius: 14px;
      background: rgba(7,12,28,.45);
      overflow:hidden;
    }
    summary{
      cursor:pointer;
      padding:10px 12px;
      color: var(--muted);
      font-size:12px;
      user-select:none;
    }
    pre{
      margin:0;
      padding:10px 12px 12px;
      max-height: 220px;
      overflow:auto;
      font-family: var(--mono);
      font-size:11px;
      color:#dfe7ff;
      background: rgba(0,0,0,.25);
      border-top:1px solid rgba(34,50,90,.35);
      white-space: pre-wrap;
      word-break: break-word;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo"></div>
        <div class="title">
          <b>Live Timing</b>
          <span>Estilo F1 Â· datos desde RaceControl WS (server-manager)</span>
        </div>
      </div>

      <div class="controls">
        <div class="field">
          <label>Host</label>
          <input id="host" value="192.168.0.12:8773" />
        </div>
        <div class="field">
          <label>Server</label>
          <input id="serverIdx" class="short" value="0" />
        </div>
        <div class="field" style="min-width:320px">
          <label>Mapa</label>
          <input id="mapUrl" value="http://192.168.0.12:8773/content/tracks/fn_bahrain/bahrain_f1_2025/map.png" />
        </div>

        <button id="btnConnect" class="btn">âš¡ Conectar</button>
        <button id="btnDisconnect" class="btn danger" style="display:none;">â›” Cortar</button>
        <button id="btnPickMe" class="btn secondary" title="ElegÃ­ quÃ© piloto sos para pintarlo distinto en el mapa">ðŸŽ¯ Yo</button>

        <div class="chip" title="Estado de conexiÃ³n">
          <span id="statusDot" class="dot warn"></span>
          <span id="statusTxt" class="mono">idle</span>
        </div>

        <div class="chip" title="Pilotos conectados ahora mismo">
          <span class="dot ok"></span>
          <span><b id="onlineCount">0</b> online</span>
        </div>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT: standings -->
      <div class="card">
        <div class="hd">
          <h2>ONLINE NOW</h2>
          <small id="sessionInfo">Sin sesiÃ³n</small>
        </div>
        <div class="bd">
          <div class="hint" id="tip">
            Si no ves nombres, es porque tu UI no estaba leyendo el snapshot <span class="mono">EventType 200</span>.
            Este panel lo usa para poblar <span class="mono">DriverName</span> y el resto, y el <span class="mono">EventType 53</span> sÃ³lo mueve los puntitos.
          </div>

          <div style="margin-top:10px; border:1px solid rgba(34,50,90,.55); border-radius:14px; overflow:hidden;">
            <table>
              <thead>
                <tr>
                  <th class="pos">POS</th>
                  <th>PILOTO</th>
                  <th>AUTO</th>
                  <th class="right">LAPS</th>
                  <th class="right">LAST</th>
                  <th class="right">BEST</th>
                  <th class="right">TOP</th>
                </tr>
              </thead>
              <tbody id="tbodyLive">
                <tr><td colspan="7" class="hint" style="padding:14px;">ConectÃ¡ y arrancamosâ€¦</td></tr>
              </tbody>
            </table>
          </div>

          <div style="margin-top:12px;">
            <div class="badge live"><span class="tiny"></span> Live</div>
            <span class="hint">Orden y tiempos vienen del snapshot. PosiciÃ³n del mapa se actualiza con eventos rÃ¡pidos.</span>
          </div>

          <details>
            <summary>ðŸ§ª Debug (Ãºltimo mensaje crudo)</summary>
            <pre id="debug">(vacÃ­o)</pre>
          </details>
        </div>
      </div>

      <!-- RIGHT: map -->
      <div class="card">
        <div class="hd">
          <h2>TRACK MAP</h2>
          <small class="mono" id="trackTxt">â€”</small>
        </div>
        <div class="bd">
          <div class="mapWrap">
            <img id="mapImg" alt="mapa" />
            <div class="layer" id="mapLayer"></div>
          </div>

          <div class="miniRow">
            <div class="toggles">
              <label class="toggle"><input id="flipX" type="checkbox"> Flip X</label>
              <label class="toggle"><input id="flipY" type="checkbox" checked> Flip Y</label>
              <label class="toggle"><input id="swapXZ" type="checkbox"> Swap X/Z</label>
              <button id="btnCenter" class="btn secondary" title="Recalcula bounds usando los Ãºltimos puntos">ðŸ§­ Fit</button>
            </div>
            <div class="hint mono" id="mapMeta">map: â€”</div>
          </div>

          <div class="hint" style="margin-top:10px;">
            Tip: si el mapa te queda espejo o invertido, tocÃ¡ los toggles. Los guarda en el navegador.
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  // ---------- utils ----------
  const $ = (id) => document.getElementById(id);

  const fmtTime = (ms) => {
    if (!isFinite(ms) || ms <= 0) return "â€”";
    const total = Math.floor(ms);
    const m = Math.floor(total / 60000);
    const s = Math.floor((total % 60000) / 1000);
    const x = total % 1000;
    const mm = m > 0 ? String(m).padStart(2,"0") + ":" : "";
    return `${mm}${String(s).padStart(2,"0")}.${String(x).padStart(3,"0")}`;
  };

  // Go time.Duration JSON => number (nanoseconds) normalmente
  const durNsToMs = (ns) => {
    if (ns == null) return 0;
    const n = Number(ns);
    if (!isFinite(n)) return 0;
    return n / 1e6;
  };

  const safeStr = (v) => (v == null ? "" : String(v));

  // ---------- state ----------
  let ws = null;
  let connected = false;

  // driver data keyed by GUID
  const drivers = new Map(); // guid -> { guid, name, car, pos, laps, bestMs, lastMs, topSpeed, lastSeen, carId, lastPos:{x,z} }
  let carIdToGuid = new Map(); // carId -> guid

  // for map transform
  let mapImgNatural = { w: 1, h: 1 };
  let trackMapData = null; // from snapshot if available

  // for bounds fitting
  let bounds = { minX: -50, maxX: 50, minZ: -50, maxZ: 50 };
  let meGuid = localStorage.getItem("lt_meGuid") || "";

  // toggles persisted
  const tFlipX = $("flipX");
  const tFlipY = $("flipY");
  const tSwapXZ = $("swapXZ");

  const loadToggles = () => {
    tFlipX.checked = localStorage.getItem("lt_flipX") === "1";
    tFlipY.checked = localStorage.getItem("lt_flipY") !== "0"; // default true
    tSwapXZ.checked = localStorage.getItem("lt_swapXZ") === "1";
  };
  const saveToggles = () => {
    localStorage.setItem("lt_flipX", tFlipX.checked ? "1" : "0");
    localStorage.setItem("lt_flipY", tFlipY.checked ? "1" : "0");
    localStorage.setItem("lt_swapXZ", tSwapXZ.checked ? "1" : "0");
  };

  [tFlipX, tFlipY, tSwapXZ].forEach(el => el.addEventListener("change", () => {
    saveToggles();
    renderMap();
  }));
  loadToggles();

  // ---------- UI status ----------
  const setStatus = (kind, text) => {
    $("statusTxt").textContent = text;
    const d = $("statusDot");
    d.classList.remove("ok","bad","warn");
    d.classList.add(kind);
  };

  const updateOnlineChip = () => {
    $("onlineCount").textContent = String(drivers.size);
  };

  // ---------- connection ----------
  const wsUrlFromInputs = () => {
    const host = $("host").value.trim();
    const serverIdx = $("serverIdx").value.trim() || "0";
    // NOTE: para Netlify/https vas a necesitar wss:// (lo arreglamos despuÃ©s con un proxy/tunnel).
    const proto = (location.protocol === "https:") ? "wss" : "ws";
    return `${proto}://${host}/api/race-control?server=${encodeURIComponent(serverIdx)}`;
  };

  const connect = () => {
    disconnect();

    const url = wsUrlFromInputs();
    setStatus("warn", "conectandoâ€¦");
    $("btnConnect").style.display = "none";
    $("btnDisconnect").style.display = "inline-flex";

    try{
      ws = new WebSocket(url);
    }catch(e){
      setStatus("bad", "WS error");
      $("btnConnect").style.display = "inline-flex";
      $("btnDisconnect").style.display = "none";
      alert("No pude crear el WebSocket:\n" + e.message);
      return;
    }

    ws.onopen = () => {
      connected = true;
      setStatus("ok", "online");
    };

    ws.onclose = () => {
      connected = false;
      setStatus("bad", "offline");
      $("btnConnect").style.display = "inline-flex";
      $("btnDisconnect").style.display = "none";
    };

    ws.onerror = () => {
      setStatus("bad", "error");
    };

    ws.onmessage = (ev) => {
      $("debug").textContent = ev.data;
      let msg;
      try { msg = JSON.parse(ev.data); } catch { return; }
      handleMessage(msg);
    };
  };

  const disconnect = () => {
    if (ws) {
      try { ws.close(); } catch {}
      ws = null;
    }
    connected = false;
  };

  $("btnConnect").addEventListener("click", connect);
  $("btnDisconnect").addEventListener("click", () => {
    disconnect();
    setStatus("warn","idle");
    $("btnConnect").style.display = "inline-flex";
    $("btnDisconnect").style.display = "none";
  });

  // ---------- snapshot parsing (EventType 200) ----------
  const parseSnapshot200 = (rc) => {
    // rc = RaceControl struct (Message)
    // Pull session/track info if present
    const si = rc.SessionInfo || null;
    const ti = rc.TrackInfo || null;
    trackMapData = rc.TrackMapData || trackMapData || null;

    // session label
    const sessionName =
      (si && (si.Name || si.SessionName || si.SessionType)) ? (si.Name || si.SessionName || si.SessionType) : "SesiÃ³n";
    const timeLeft =
      (si && (si.TimeLeft != null)) ? ` Â· TL ${fmtTime(Number(si.TimeLeft)/1000)}` : "";
    $("sessionInfo").textContent = `${sessionName}${timeLeft}`;

    // track label
    const track =
      (ti && (ti.TrackName || ti.Name || ti.Track)) ? (ti.TrackName || ti.Name || ti.Track) : "â€”";
    const layout =
      (ti && (ti.LayoutName || ti.Layout)) ? (" Â· " + (ti.LayoutName || ti.Layout)) : "";
    $("trackTxt").textContent = `${track}${layout}`;

    // carIdToGuid mapping (keys can come as strings)
    if (rc.CarIDToGUID) {
      const next = new Map();
      for (const [k,v] of Object.entries(rc.CarIDToGUID)) next.set(Number(k), String(v));
      carIdToGuid = next;
    }

    // ConnectedDrivers is a DriverMap: { Drivers: {guid: RaceControlDriver}, GUIDsInPositionalOrder: [] }
    const cd = rc.ConnectedDrivers;
    if (!cd || !cd.Drivers) return;

    // rebuild drivers map from snapshot (pero conservamos lastPos si ya lo venÃ­amos moviendo con EventType 53)
    const prev = new Map(drivers);

    drivers.clear();

    const order = Array.isArray(cd.GUIDsInPositionalOrder) ? cd.GUIDsInPositionalOrder : Object.keys(cd.Drivers);

    for (const guid of order) {
      const d = cd.Drivers[guid];
      if (!d) continue;

      const carInfo = d.CarInfo || {};
      const name = carInfo.DriverName || carInfo.driverName || carInfo.Name || "â€”";
      const carModel = carInfo.CarModel || carInfo.carModel || "";
      const carId = (carInfo.CarID != null) ? Number(carInfo.CarID) : (carInfo.CarId != null ? Number(carInfo.CarId) : null);

      // find current car lap info
      let carLap = null;
      if (d.Cars && carModel && d.Cars[carModel]) carLap = d.Cars[carModel];
      else if (d.Cars) {
        const firstKey = Object.keys(d.Cars)[0];
        if (firstKey) carLap = d.Cars[firstKey];
      }

      const bestMs = carLap ? durNsToMs(carLap.BestLap) : 0;
      const lastMs = carLap ? durNsToMs(carLap.LastLap) : 0;
      const laps = carLap ? Number(carLap.NumLaps || 0) : Number(d.TotalNumLaps || 0);
      const top = carLap ? Number(carLap.TopSpeedBestLap || carLap.TopSpeedThisLap || 0) : 0;

      const prettyCar =
        (carLap && carLap.CarName) ? carLap.CarName : (carModel || "â€”");

      // keep last pos from previous (map)
      const prevD = prev.get(String(guid));
      const lastPos = prevD && prevD.lastPos ? prevD.lastPos : (d.LastPos || null);

      drivers.set(String(guid), {
        guid: String(guid),
        name: String(name),
        car: String(prettyCar),
        pos: Number(d.Position || 0),
        laps,
        bestMs,
        lastMs,
        topSpeed: top,
        carId,
        lastPos,
        lastSeen: Date.now()
      });
    }

    updateOnlineChip();
    renderTable();
    renderMapMeta();
  };

  // ---------- realtime position update (EventType 53) ----------
  const parsePos53 = (m) => {
    // m = udp.CarUpdate (frecuente) -> CarID, Pos {X,Y,Z} (o Vec), etc.
    const carId = (m.CarID != null) ? Number(m.CarID) : (m.CarId != null ? Number(m.CarId) : null);
    if (carId == null) return;

    const pos = m.Pos || m.pos || m.Position || m.position || null;
    if (!pos) return;

    const x = Number(pos.X ?? pos.x ?? 0);
    const z = Number(pos.Z ?? pos.z ?? 0);

    // map carId -> guid
    const guid = carIdToGuid.get(carId);
    if (!guid) return;

    const d = drivers.get(String(guid));
    if (!d) return;

    d.lastPos = { x, z };
    d.lastSeen = Date.now();
  };

  // ---------- generic message handler ----------
  const handleMessage = (packet) => {
    const et = Number(packet.EventType);
    const m = packet.Message;

    // Snapshot total
    if (et === 200 && m) {
      parseSnapshot200(m);
      return;
    }

    // Realtime pos
    if (et === 53 && m) {
      parsePos53(m);
      // update bounds slowly + render map
      growBoundsFromDrivers();
      renderMap();
      return;
    }

    // Some other events can also bring updated snapshot (segÃºn server-manager)
    // but the key one is 200.
  };

  // ---------- table rendering ----------
  const renderTable = () => {
    const tbody = $("tbodyLive");
    const arr = Array.from(drivers.values()).sort((a,b) => (a.pos||999) - (b.pos||999));

    if (arr.length === 0) {
      tbody.innerHTML = `<tr><td colspan="7" class="hint" style="padding:14px;">No hay pilotos conectados.</td></tr>`;
      return;
    }

    // leader highlight
    const leaderGuid = arr[0]?.guid || "";

    tbody.innerHTML = arr.map(d => {
      const isLeader = d.guid === leaderGuid;
      const isMe = (meGuid && d.guid === meGuid);

      const badge = `<span class="badge live" title="Conectado ahora"><span class="tiny"></span> ONLINE</span>`;
      const pos = d.pos || "â€”";
      const last = fmtTime(d.lastMs);
      const best = fmtTime(d.bestMs);
      const top = (d.topSpeed && isFinite(d.topSpeed) && d.topSpeed > 0) ? `${Math.round(d.topSpeed)} km/h` : "â€”";

      return `
        <tr class="${isLeader ? "leader" : ""}">
          <td class="pos">${pos}</td>
          <td>
            <span class="name">${escapeHtml(d.name || "â€”")}${isMe ? " <span class='mono' style='color:#ff5a9e'>(yo)</span>" : ""}</span>
            <span class="sub mono">${escapeHtml(d.guid.slice(0,8))} Â· ${badge}</span>
          </td>
          <td>
            <span class="mono">${escapeHtml(d.car || "â€”")}</span>
          </td>
          <td class="right mono">${d.laps ?? 0}</td>
          <td class="right mono">${last}</td>
          <td class="right mono"><b>${best}</b></td>
          <td class="right mono">${top}</td>
        </tr>
      `;
    }).join("");
  };

  const escapeHtml = (s) => String(s).replace(/[&<>"']/g, (c) => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[c]));

  // ---------- map ----------
  const renderMapMeta = () => {
    const m = trackMapData;
    if (!m) { $("mapMeta").textContent = "map: manual"; return; }
    const parts = [];
    if (m.width != null) parts.push(`w=${round2(m.width)}`);
    if (m.height != null) parts.push(`h=${round2(m.height)}`);
    if (m.scale_factor != null) parts.push(`s=${round2(m.scale_factor)}`);
    $("mapMeta").textContent = "map: " + (parts.join(" ") || "ok");
  };

  const round2 = (n) => (isFinite(Number(n)) ? Number(n).toFixed(2) : "â€”");

  const growBoundsFromDrivers = () => {
    // update bounds using lastPos of known drivers (soft)
    let minX = Infinity, maxX = -Infinity, minZ = Infinity, maxZ = -Infinity;
    let count = 0;

    for (const d of drivers.values()) {
      if (!d.lastPos) continue;
      const x = Number(d.lastPos.x);
      const z = Number(d.lastPos.z);
      if (!isFinite(x) || !isFinite(z)) continue;
      minX = Math.min(minX, x);
      maxX = Math.max(maxX, x);
      minZ = Math.min(minZ, z);
      maxZ = Math.max(maxZ, z);
      count++;
    }

    if (count < 3) return;

    // add padding
    const padX = Math.max(20, (maxX - minX) * 0.15);
    const padZ = Math.max(20, (maxZ - minZ) * 0.15);

    bounds = {
      minX: minX - padX,
      maxX: maxX + padX,
      minZ: minZ - padZ,
      maxZ: maxZ + padZ
    };
  };

  $("btnCenter").addEventListener("click", () => {
    growBoundsFromDrivers();
    renderMap();
  });

  const worldToMapPx = (x, z) => {
    // prefer TrackMapData if available, else bounds normalized
    const flipX = tFlipX.checked;
    const flipY = tFlipY.checked;
    const swapXZ = tSwapXZ.checked;

    let wx = x, wz = z;
    if (swapXZ) { const t = wx; wx = wz; wz = t; }

    // 1) if trackMapData exists, try deterministic mapping
    if (trackMapData && (trackMapData.scale_factor != null || trackMapData.ScaleFactor != null)) {
      // Accept both camelCase and snake_case
      const sf = Number(trackMapData.scale_factor ?? trackMapData.ScaleFactor ?? 1);
      const margin = Number(trackMapData.margin ?? trackMapData.Margin ?? 0);
      const ox = Number(trackMapData.offset_x ?? trackMapData.OffsetX ?? 0);
      const oz = Number(trackMapData.offset_y ?? trackMapData.OffsetZ ?? trackMapData.offset_z ?? 0);

      const wRef = Number(trackMapData.width ?? trackMapData.Width ?? mapImgNatural.w);
      const hRef = Number(trackMapData.height ?? trackMapData.Height ?? mapImgNatural.h);

      // classic guess used by many track-map inis
      let px = (wx + ox) * sf + margin;
      let py = (wz + oz) * sf + margin;

      // scale to actual image pixels if needed
      const rx = mapImgNatural.w / (wRef || mapImgNatural.w);
      const ry = mapImgNatural.h / (hRef || mapImgNatural.h);

      px *= rx;
      py *= ry;

      if (flipX) px = mapImgNatural.w - px;
      if (flipY) py = mapImgNatural.h - py;

      return { px, py };
    }

    // 2) fallback: normalize with bounds
    let nx = (wx - bounds.minX) / (bounds.maxX - bounds.minX);
    let nz = (wz - bounds.minZ) / (bounds.maxZ - bounds.minZ);

    nx = Math.min(1, Math.max(0, nx));
    nz = Math.min(1, Math.max(0, nz));

    if (flipX) nx = 1 - nx;
    if (flipY) nz = 1 - nz;

    return {
      px: nx * mapImgNatural.w,
      py: nz * mapImgNatural.h
    };
  };

  const renderMap = () => {
    const layer = $("mapLayer");
    // clear
    layer.innerHTML = "";

    // compute container rect size
    const wrap = layer.getBoundingClientRect();
    // But our transform uses natural image size, need scale factor from natural->display
    const displayW = wrap.width;
    const displayH = wrap.height;

    // We use natural size; get scale
    const sx = displayW / mapImgNatural.w;
    const sy = displayH / mapImgNatural.h;

    const now = Date.now();
    for (const d of drivers.values()) {
      if (!d.lastPos) continue;
      // drop stale dots if no updates in a while
      if (now - d.lastSeen > 8000) continue;

      const { px, py } = worldToMapPx(d.lastPos.x, d.lastPos.z);

      const el = document.createElement("div");
      el.className = "carDot" + ((meGuid && d.guid === meGuid) ? " me" : "");
      el.style.left = (px * sx) + "px";
      el.style.top  = (py * sy) + "px";

      const label = document.createElement("div");
      label.className = "carLabel";
      label.textContent = d.name || "â€”";
      el.appendChild(label);

      layer.appendChild(el);
    }
  };

  // ---------- "Yo" picker ----------
  $("btnPickMe").addEventListener("click", () => {
    const arr = Array.from(drivers.values()).sort((a,b) => (a.pos||999) - (b.pos||999));
    if (arr.length === 0) { alert("TodavÃ­a no hay pilotos para elegir."); return; }

    const list = arr.map(d => `${d.pos || "â€”"} - ${d.name} (${d.guid.slice(0,8)})`).join("\n");
    const chosen = prompt("Pegame el GUID (o los primeros 8) del piloto que sos:\n\n" + list, meGuid ? meGuid.slice(0,8) : "");
    if (!chosen) return;

    const needle = chosen.trim().toLowerCase();
    const found = arr.find(d => d.guid.toLowerCase() === needle || d.guid.slice(0,8).toLowerCase() === needle);
    if (!found) { alert("No encontrÃ© ese GUID."); return; }

    meGuid = found.guid;
    localStorage.setItem("lt_meGuid", meGuid);
    renderTable();
    renderMap();
  });

  // ---------- map image loading ----------
  const loadMap = () => {
    const url = $("mapUrl").value.trim();
    const img = $("mapImg");
    img.onload = () => {
      mapImgNatural.w = img.naturalWidth || 1;
      mapImgNatural.h = img.naturalHeight || 1;
      $("mapMeta").textContent = `map: ${mapImgNatural.w}x${mapImgNatural.h}`;
      renderMap();
    };
    img.onerror = () => {
      $("mapMeta").textContent = "map: error al cargar";
    };
    img.src = url + (url.includes("?") ? "&" : "?") + "v=" + Date.now();
  };

  $("mapUrl").addEventListener("change", loadMap);
  loadMap();

  // auto refresh map occasionally (tracks sometimes update/contain)
  setInterval(() => {
    if (!connected) return;
    // refresh dots
    renderMap();
  }, 350);

  // start idle
  setStatus("warn","idle");
})();
</script>
</body>
</html>
